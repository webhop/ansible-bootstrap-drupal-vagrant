---

- name: Install pip
  apt:
    name: python-pip

- name: Install packages
  pip:
    name: "{{ item }}"
  with_items:
    - MySQL-python
    - boto

- name: Create a MySQL database for Drupal.
  mysql_db:
    db: "{{ drupal_mysql_database }}"
    state: present

- name: Create a MySQL user for Drupal.
  mysql_user:
    name: "{{ drupal_mysql_user }}"
    host: "{{ item }}"
    priv: "{{ drupal_mysql_database }}.*:ALL"
    password: "{{ drupal_mysql_password }}"
  with_items:
    - 127.0.0.1
    - ::1
    - localhost

- name: Check for existence of Drupal database
  command: '/usr/bin/mysql -N -s -u {{ drupal_mysql_user }} -p{{ drupal_mysql_password }} -e "SELECT COUNT(1) FROM information_schema.tables WHERE table_schema=''drupal'';"'
  register: drupal_table_count

- name: Copy Drupal settings in for vagrant image
  template:
    src: settings.php.j2
    dest: "{{ doc_root }}/sites/default/settings.php"
    owner: www-data
    group: www-data
    mode: 0644

- name: Copy local settings in for vagrant image
  template:
    src: local_settings.php.j2
    dest: "{{ doc_root }}/sites/default/local_settings.php"
    owner: www-data
    group: www-data
    mode: 0644

- name: Check if Drupal can be bootstrapped
  command: /usr/local/bin/drush status-report
  args:
    chdir: "{{ doc_root }}"
  ignore_errors: yes
  no_log: true
  register: drupal_bootstrapped

- name: Setting timestamp fact for naming purposes
  set_fact: epoch="{{ lookup('pipe','date +%Y%m%d%H%M%S') }}"
  when: restore_db_backup or restore_files_backup

- name: Retrieve DB backup from s3
  s3:
    region: "{{ region }}"
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    mode: get
    bucket: "{{ s3_bucket }}"
    object: "{{ database_backup_name }}"
    dest: "/tmp/{{ database_backup_name }}"
  when: restore_db_backup and db_backup_url is not defined

- name: Import the DB backup
  mysql_db:
    state: import
    name: "{{ drupal_mysql_database }}"
    target: "/tmp/{{ database_backup_name }}"
  when: restore_db_backup and db_backup_url is not defined

- name: Retrieve files backup from s3
  s3:
    region: "{{ region }}"
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    mode: get
    bucket: "{{ s3_bucket }}"
    object: "{{ files_backup_name }}"
    dest: "/tmp/{{ files_backup_name }}"
  when: restore_files_backup

- name: Extract the files backup
  sudo: yes
  unarchive:
    src: "/tmp/{{ files_backup_name }}"
    dest: "{{ doc_root }}/sites/default"
    owner: www-data
    group: www-data
    copy: no
  when: restore_files_backup

# What if we want to restore DB from a 'public' store?
- name: Retrieve sanitised DB backup
  get_url:
    url: "{{ db_backup_url }}"
    dest: "/tmp/db_backup.sql.gz"
  when: db_backup_url is defined

# Extract DB backup
- name: Import the DB backup
  mysql_db:
    state: import
    name: "{{ drupal_mysql_database }}"
    target: "/tmp/db_backup.sql.gz"
  when: db_backup_url is defined

# Download the stage_file_proxy module (when we aren't explicitly restoring the files dump)
- name: Install the stage_file_proxy drupal module
  command: "/usr/local/bin/drush pm-download stage_file_proxy"
  args:
    chdir: "{{ doc_root }}"
  when: not restore_files_backup

- name: Enable the stage_file_proxy module
  command: "/usr/local/bin/drush pm-enable stage_file_proxy -y"
  args:
    chdir: "{{ doc_root }}"
  when: not restore_files_backup

# Set site to use stage for assets (instead of downloading locally)
- name: Set the stage URL for the stage_file_proxy module
  command: "/usr/local/bin/drush variable-set stage_file_proxy_origin '{{ drupal_stage_site_url }}'"
  args:
    chdir: "{{ doc_root }}"
  when: not restore_files_backup

- name: Run Drupal site-install
  command: "/usr/local/bin/drush site-install {{ drupal_install_profile }} --site-name={{ drupal_site_name }} -y"
  args:
    chdir: "{{ doc_root }}"
  when: drupal_bootstrapped.rc != 0 and not restore_db_backup
  tags: install

- name: Update Drupal schema
  command: /usr/local/bin/drush updatedb -y
  args:
    chdir: "{{ doc_root }}"
  when: drupal_bootstrapped.rc ==  0
  tags: update

- name: Check if Drupal Features are enabled
  command: '/usr/bin/mysql -N -s -u {{ drupal_mysql_user }} -p{{ drupal_mysql_password }} -e "SELECT 1 FROM system WHERE name = ''features'' AND status = 1;" {{ drupal_mysql_database }}'
  when: drupal_bootstrapped.rc ==  0
  tags: update
  register: drupal_enabled_features

- name: Revert Drupal Features
  command: /usr/local/bin/drush features-revert-all -y
  args:
    chdir: "{{ doc_root }}"
  when: drupal_bootstrapped.rc ==  0 and drupal_enabled_features.stdout|int ==  1
  tags: update

- name: Clear the drupal cache
  command: /usr/local/bin/drush cache-clear all
  args:
    chdir: "{{ doc_root }}"
  when: drupal_bootstrapped.rc ==  0

- name: Check if Drupal Set Environment is enabled
  command: '/usr/bin/mysql -N -s -u {{ drupal_mysql_user }} -p{{ drupal_mysql_password }} -e "SELECT 1 FROM system WHERE name = ''set_environment'' AND status = 1;" {{ drupal_mysql_database }}'
  when: drupal_bootstrapped.rc ==  0
  tags: update
  register: drupal_enabled_set_env

- name: Set the drupal environment
  command: /usr/local/bin/drush set-environment --force
  args:
    chdir: "{{ doc_root }}"
  when: drupal_bootstrapped.rc ==  0 and drupal_enabled_set_env.stdout|int ==  1
